## QA. 1

###### Что такое частичный индекс?

- Создается только для тех строк таблицы, которые удовлетворяют определенному условию. Это значит, что индекс будет использоваться только для части данных, а не для всей таблицы

```sql
CREATE INDEX idx_unfinished_orders ON orders (order_date) WHERE status = 'pending';
```

###### Зачем нужны свойства ACID в работе с базами данных? Как они применяются в транзакциях?

- [[../../../_inforage/Базы данных/Storage/Транзакции/ACID]]
- Atomicity - говорит что транзакция, выполниться полностью или не выполниться вообще. Не допустимо выполнение отдельных операций
- Consistency - согласованность данных, если кто-то выкупил товар, другой пользователь не может купить снова уже несуществующий товар
- Isolation - транзакции могут быть иметь разного уровня изоляции.
- Durability - если мы закоммитили транзакцию, база данных точно их сохранит в дальнейшем, даже если после коммита база упала

###### Какие блокировки используются при работе с транзакциями в базах данных?

- Shared (совместная блокировка) (MySQL):

```sql
SELECT * FROM users WHERE user_id = 1 LOCK IN SHARE MODE;
```

Этот запрос позволяет другим транзакциям читать эти данные, но **не изменять их**, пока блокировка не будет снята.

- Exclusive (эксклюзивная блокировка):

```sql
SELECT * FROM users WHERE user_id = 1 FOR UPDATE;
```

Этот запрос **блокирует данные** для текущей транзакции, так что **никакие другие транзакции не могут ни читать, ни изменять эти данные** до снятия блокировки.


###### Оптимистичные и пессимистичные блокировки транзакций

Оптимистичная блокировка предполагает, что **конфликты редки**. Транзакции выполняются без блокировки данных, и **только при попытке сохранения изменений система проверяет, были ли данные изменены другим пользователем**. **Если данные изменились, транзакция откатывается**. В Hibernate для этого часто используется поле **@Version**, которое помогает отслеживать изменения в данных.

Пессимистичная блокировка подразумевает, что **данные блокируются сразу при чтении, чтобы другие транзакции не могли ни читать, ни изменять их, пока текущая транзакция не завершена**. Это гарантирует целостность данных, но может снижать производительность системы, особенно при большом количестве конкурентных транзакций.

###### Какие есть виды оптимистично блокировки

- По версии - каждый объект или запись в базе данных имеет версионное поле, которое отслеживает текущую версию данных. Когда транзакция извлекает данные, она также извлекает версию этих данных. При попытке обновить данные, проверяется версия: если версия в базе данных отличается от версии, которая была извлечена транзакцией, это значит, что данные были изменены другой транзакцией, и обновление не может быть выполнено.
- По временным меткам

###### Что ты знаешь о проблемах с транзакциями и безопасностью?

Проблемы с транзакциями:

1. Нарушение изоляции (грязное чтение, неповторяющееся чтение, фантомные чтения) — возникают, когда неправильно настроены уровни изоляции транзакций.
2. Неправильная настройка Propagation — вызывает несогласованность данных, если методы, участвующие в транзакции, работают в разных транзакциях.
3. Неправильное управление транзакциями — ошибки при коммите и роллбэке могут привести к сохранению некорректных данных.
4. Нарушение ACID — если транзакции не атомарны, это может вызвать частичное выполнение операций и оставить базу данных в некорректном состоянии.
5. Взаимные блокировки

Проблемы с безопасностью:

1. Неправильная настройка ролей и разрешений — пользователи могут получить доступ к операциям, к которым они не должны иметь доступ.
2. Ошибки в аутентификации — недостаточная проверка аутентификации может позволить пользователям войти в систему без проверки.
3. Проблемы с токенами и сессиями — устаревшие токены или сессии могут остаться активными, создавая риск для безопасности.
4. Уязвимости CSRF — отсутствие защиты от CSRF-атак может позволить злоумышленникам совершать действия от имени пользователя.
5. Неправильная настройка CORS — может открыть доступ для внешних сайтов и повысить риск атак.

###### JOIN vs UNION + (UNION ALL)

Основное различие между JOIN и UNION заключается в том, что JOIN объединяет данные из разных таблиц, создавая новые столбцы, тогда как UNION объединяет результаты нескольких SELECT-запросов, создавая новые строки.

```sql
SELECT first_name, middle_name, "teacher" as role FROM Teacher
UNION
SELECT first_name, middle_name, "student" as role FROM Student
```

###### Примеры денормализации, в сторону оптимизации.

- [[../../../_inforage/Базы данных/Storage/Денормализация]]

###### Как работает составной индекс?

- [[../../../_inforage/Базы данных/Storage/Индексирование#Составной индекс]]

###### Какие существуют уровни изолированности транзакций и их проблемы?

- [[../../../_inforage/Базы данных/Storage/Изоляции транзакций]]
- [[../../../_inforage/Базы данных/Storage/Изоляции транзакций#Проблемы изоляции]]

###### В чем отличие синхронной транзакций от асинхронной?

Синхронные транзакции:

- Блокировка при ожидании ответа
- Последовательность выполнения, согласованность данных
- Более длительное время ожидания и возможные задержки, особенно в случае медленного соединения или перегрузки сервера.

Асинхронные транзакции:

- Нету блокировки, продолжение выполнение других операций
- Более эффективное использование ресурсов
- Дополнительное обработка, результаты могут приходить в разное время

###### В чем разница между Stateful и stateless моделями транзакций

**Stateful транзакции**:

- Сохраняют состояние между вызовами.
- Используются в приложениях с сессиями (например, веб-приложения).
- Могут усложнить код и масштабируемость.
- пример: сохранение состояние корзины в сессии

**Stateless транзакции**:

- Не сохраняют состояние между вызовами.
- Используются в RESTful API.
- Упрощают масштабируемость, но могут потребовать больше данных для каждого запроса.

###### Как обеспечиваются свойства ACID в MongoDB и почему это важно?


###### Что такое теорема CAP, и какие базы данных относятся к каждому типу (CA, CP, AP)?

- [CAP - теорема](../../../_inforage/Microservices/Storage/CAP%20-%20теорема.md)
- CA - PostgreSQL, MySQL, Oracle, MariaDB
- AP - Cassandra, CouchDB, Dynamo
- CP - Redis, MongoDB, Neo4J

###### В чем разница между подходами BASE и ACID в контексте баз данных? BASE vs ACID

[Краткое описание различий между ACID и BASE](../../../_inforage/Базы%20данных/Storage/BASE.md#Краткое%20описание%20различий%20между%20ACID%20и%20BASE)

###### Назови ddl запросы?

DDL-команды изменяют структуру БД

- **`CREATE`** – создание таблиц, баз данных, индексов.
- **`ALTER`** – изменение структуры таблицы (добавление, удаление, изменение столбцов).
- **`DROP`** – удаление таблиц, баз данных, индексов.
- **`TRUNCATE`** – очистка таблицы (удаление всех данных без удаления таблицы).
- **`RENAME`** – переименование таблиц.

#### Что лучше join или подзапрос?

- **JOIN использует индексы обеих таблиц**, что снижает количество сканируемых строк.
- **Подзапрос может выполняться для каждой строки**, вызывая множественные обращения к данным.
- **JOIN позволяет оптимизатору БД строить более эффективный план выполнения**, используя сортировку и хеш-таблицы.
- **Подзапрос может быть преобразован в JOIN** самим оптимизатором, но не всегда.
- **JOIN выполняет операцию объединения на этапе выборки**, тогда как подзапрос может создавать временные таблицы.
- **Подзапрос в `WHERE` может ограничить использование индексов**, приводя к полному сканированию таблицы.

###### Какие виды индексов есть?

- Кластерный
- Не кластерный
- Составной (Composite Index) — индекс, который строится по нескольким столбцам таблицы. В данном типе индекса расположение полей является важным.
- Текстовые индексы (Full-Text Search)

```sql
CREATE INDEX idx_full_text_search ON articles USING gin (to_tsvector('english', content));
```

- Частичный (Partial Indexes) — индекс, который состоит из подмножеств строк таблицы по определенному выражению.

```sql
CREATE INDEX idx_active_users ON users (last_name)
WHERE active = true;
```
###### Какие структуры индексов есть?

- **B-tree** — стандартная структура для большинства индексов в PostgreSQL. Используется для поиска по диапазонам и равенствам.
- **Hash** — используется для быстрого поиска по хешированию (работает только с операциями равенства).
- **GIN (Generalized Inverted Index)** — используется для полнотекстового поиска и индексирования массивов, JSONB и других типов данных.
- **GiST (Generalized Search Tree)** — используется для индексации географических данных, многомерных данных и других сложных типов данных.

###### Для чего плоха hash индекс структура в базе

- Годится для точного вычисления хэша, когда мы ищем точно значение по =
- Не подходит для диапазонных значений

###### Что такое оконные функции

- https://sql-academy.org/ru/guide/windows-functions
- можем использовать агрегации по патрициям
###### Какие есть оконные функции

- SUM(total) OVER (PARTITION BY user_id) AS total_expenses
- SUM(total) OVER (PARTITION BY user_id ORDER BY start_date) AS cumulative_total
- AVG(total) OVER (PARTITION BY user_id ORDER BY start_date) AS avg_expenses
- ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY start_date) AS row_num Присваивает уникальный номер каждой строке в окне (сортировка обязательна).
- RANK() OVER (PARTITION BY user_id ORDER BY total DESC) AS rank Присваивает уникальные ранги строкам в окне, при этом строки с одинаковыми значениями получают одинаковый рейтинг, но пропускается следующий ранг.


###### Чем отличается view от materialist view?

- **View** = "Окно" в реальные данные (всегда актуально, но медленно).
- **Materialized View** = "Снимок" данных (быстро, но требует обновления).

###### Можно ли в рамках одной транзакции делать действия в разных БД?

###### Почему мы везде не можем использовать serializable?

###### Чем SQL отличается от NoSQL?

######  Если у нас есть 3 таблица 1 - User 2- Document 3- User_Document Получается связь ManyToMany Частый запрос, ищем всех пользователей без паспорта, но с водительскими права. Какой или какие нужно создать индексы не только для ускорения запроса, но и для консистентности данных?

###### Какие в postgreSQL есть механизмы оценки сложности работы?

###### Можно откатить предпоследнюю миграцию из Liquibase?

###### С помощью какого механизма, при поднятии нескольких инсансов, запуститься только одна миграция?


###### Если бы тебе предложили сделать приложение для регистрации пользователей

(Например для всей Земли), какой бы ты id выбрал бы для использования?


###### Партиционирование и шардирование? (плюсы и минусы, практическое применение).

###### Может ли таблица быть без первичного ключа?


###### Имеет ли смысл делать индекс по половому признаку

###### Чем отличается LEFT JOIN от LEFT OUTER JOIN

###### Запросы INSERT ON CONFLICT, UPDATE

## QA. 2

###### Приходилось ли использовать составные ключи в качестве первичного ключа? Когда использовать составной ключ, а когда обычный и что лучше?

###### Приходилось ли использовать CriteriaAPI? При использовании критерии в которой необходимо на фронте сделать 2 джоина. Что у нас будет в самом запросе, один джоин или два? Как это можно оптимизировать?

###### В чем особенность JSONB?


## QA. 3

###### При связи один ко многим у нас коллекция должна быть List или Set? 
В каком случае нельзя будет использовать Set? Что будет под капотом при использовании 

List? Если использовать List, то будут ли какие-то коллизии? Будут ли батчи работать правильно?

###### Common Table Expression

###### Чем хранимые процедуры отличаются от view ?

###### Синтаксис оконных функций

###### Разница оконных функций от аргегированных

###### Что тако автовакум?

###### Какие есть служебные столбцы таблиц?

###### Разница BTree vs бинарное дерево

###### Разница BTree vs красно черное дерево
## Задачи

###### Что делать, если надо получать только часть записей из БД, а не все сразу?

###### Мы изменили у каждого юзера имя, почему размер на диске увеличился в два раза?

###### Как написать запрос в котором параметры поиска могут динамически изменяться? 
То есть сначала 2 параметра пришло и на надо делать поиск по двум параметрам. Потом один пришел и нам уже надо по одному параметру делать запрос и т.д.



## Resources

- [Требования ACID. BASE модель. CAP теорема](https://datatalks.ru/acid-base-cap-theorem-for-databases/#BASE_Basically_Available_Soft_state_Eventually_consistent)
- [Индексы в SQL: создание, виды и как работают](https://timeweb.cloud/tutorials/sql/indeksy-v-sql-sozdanie-vidy-i-kak-rabotayut)
- 