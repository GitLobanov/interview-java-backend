> Обрабатывает ошибки и отказы, предотвращает повторные неудачные запросы к сервисам или ресурсам, которые временно недоступны. Делится на состояния Closed, Open, Half-Open.

При взаимодействии микросервисов не исключены ситуации, когда по какой-то причине один из сервисов перестает отвечать. Справиться с временными сбоями (медленное сетевое соединение, временная недоступность и так далее) помогают повторные вызовы. Однако при более серьезных сбоях, вызванных полным отказом сервиса, повторные вызовы будут лишь расходовать ресурсы.

В таких случаях рекомендуется использовать шаблон Circuit Breaker. Микросервис будет запрашивать другой микросервис через Proxy-сервер. Он подсчитывает количество недавних сбоев и на основе него определяет, разрешать ли выполнение последующих вызовов или немедленно возвращать исключение.

Proxy-сервер может находиться в трех состояниях:

- **Closed.** Идет передача запросов между сервисами и подсчет количества сбоев. Если число сбоев за заданный интервал времени превышает пороговое значение, выключатель Proxy-сервера переводится в состояние Open.
- **Open.** Запросы от исходного сервиса немедленно возвращаются с ошибкой. По истечении заданного тайм-аута выключатель переводится в состояние Half-Open.
- **Half-Open.** Выключатель пропускает ограниченное количество запросов от исходного сервиса и подсчитывает число успешных запросов. Если необходимое количество достигнуто, выключатель переходит в состояние Closed, если нет — возвращается в статус Open.
- 
![[../../../../../_res/Pasted image 20241215103202.png]]

-  Closed (Замкнутое состояние): все запросы проходят через Circuit Breaker и направляются к внешнему сервису.
- Ошибки при обращении к сервису: если сервис начинает выдавать ошибки (например, тайм-ауты или ответы с кодом ошибки), Circuit Breaker отслеживает их. Как только количество ошибок достигает заданного порога (например, 50% запросов завершились неудачно), Circuit Breaker переключается в Open (Открытое состояние).
-  Open (Запросы блокируются) : в открытом состоянии Circuit Breaker блокирует все новые запросы к сервису и сразу возвращает ошибку (например, пользователю или другому сервису).
- Ожидание: в открытом состоянии `Circuit Breaker` остается определённое время (например, 30 секунд). Это даёт внешнему сервису время восстановиться, прежде чем система попытается снова к нему обратиться.
- Half-Open (Проверка состояния)  после истечения времени ожидания `Circuit Breaker` переходит в полуоткрытое состояние. Теперь небольшое количество запросов отправляется к внешнему сервису, чтобы проверить, восстановился ли он. Если запросы успешны, Circuit Breaker возвращается в Closed. Если ошибки повторяются, Circuit Breaker снова переходит в Open.

**Плюсы**

- Предотвращает накопление неудачных запросов к сервису.
- Позволяет контролировать использование ресурсов, таких как сетевые соединения или потоки выполнения

**Однако**

- Дополнительная сложность в отслеживании и управлении состоянием
- При блокировке запросов к сервису, может возвращать заранее определенный ответ об ошибке без обращения к сервису.

![[../../../../../_res/Pasted image 20240930144138.png]]
# Кратко

Circuit Breaker предотвращает каскадные сбои, отключая недоступные или нестабильные сервисы, когда система сталкивается с ошибками. Он переключается в открытое состояние, чтобы избежать распространения проблемы на другие части системы.  

Попасть в Open состояние можно когда порог ошибок в определенном интервале превышает порог, также есть процентный порог ошибок, превышение временного порога ответа, гибридный подход, кастомный подход.

Полуоткрытое состояние Circuit Breaker позволяет сервису восстанавливаться, не подвергая его излишней нагрузке. Раз в некоторое время он отправляет запросы на сервис, если все еще недоступен он снова падает в Open состояние, иначе в Closed и возобновляет штатную работу сервиса.

# Поднобнее
## Состояния Circuit Breaker

#### Закрытое состояние (Closed state)

В закрытом состоянии Circuit Breaker позволяет запросам проходить к защищаемому сервису. Это нормальное рабочее состояние.

В этом состоянии Circuit Breaker отслеживает количество неудачных запросов. Если число ошибок не превышает определенный порог, то Circuit Breaker продолжает оставаться в закрытом состоянии.

Обычно реализации Circuit Breaker ведут учет времени ответа и количества неудачных запросов. Это позволяет определить, когда пора переключиться в открытое состояние.
#### Открытое состояние (Open state)

В открытом состоянии Circuit Breaker блокирует все попытки выполнить запрос к защищаемому сервису. Это профилактическая мера, предотвращающая дальнейшее распространение ошибок.

Переход в открытое состояние происходит, когда количество неудачных запросов в закрытом состоянии превышает установленный порог. Этот порог может быть определен количеством ошибок, временем ответа или комбинацией обоих факторов.

После перехода в открытое состояние, Circuit Breaker остается в этом состоянии в течение определенного времени. Этот период называется временем ожидания (timeout) и является критическим для восстановления стабильности защищаемого сервиса.

#### Полуоткрытое состояние (Half-open state)

Полуоткрытое состояние - это переходное состояние, в котором Circuit Breaker начинает частично разрешать запросы к сервису для тестирования его доступности и надежности.

После истечения времени ожидания в открытом состоянии, Circuit Breaker переходит в полуоткрытое состояние. В этом состоянии он позволяет ограниченное количество запросов пройти к сервису. Если эти запросы успешно обработаны и не вызывают ошибок, Circuit Breaker возвращается в закрытое состояние, считая, что проблемы с сервисом устранены.

Если в полуоткрытом состоянии обнаруживаются ошибки, Circuit Breaker снова переходит в открытое состояние, и время ожидания начинает отсчитываться заново. Это гарантирует, что в случае повторного возникновения проблемы, нагрузка на сервис будет снижена.

## Алгоритмы определения необходимости активации Circuit Breake

#### 1. Порог ошибок (Error threshold)

Circuit Breaker переходит в открытое состояние, когда количество ошибок в определенном временном интервале превышает заданный порог.

Этот подход требует отслеживания количества неудачных запросов и их сравнения с пороговым значением. Например, если в течение минуты происходит более 50 неудачных вызовов, Circuit Breaker активируется.

Порог ошибок должен быть настроен с учетом нормальной работы сервиса и его способности к самовосстановлению.

#### 2. Процентный порог ошибок (Error rate threshold)

Вместо фиксированного количества ошибок, Circuit Breaker активируется, когда процент ошибок от общего числа запросов превышает заданный уровень.

Для этого метода необходимо отслеживать общее количество запросов и количество ошибок, а затем рассчитывать процент ошибок. Например, если более 30% запросов в течение определенного временного интервала завершаются ошибкой, Circuit Breaker активируется.

Этот подход более гибок, так как учитывает общий объем трафика и менее чувствителен к его колебаниям.

#### 3. Оценка времени ответа (Response time evaluation)

Активация Circuit Breaker происходит, если среднее время ответа сервиса превышает установленный порог.

Этот метод требует постоянного мониторинга времени отклика сервиса. Если среднее время отклика за определенный период времени превышает заданное значение, Circuit Breaker переходит в открытое состояние.

Здесь важно правильно выбрать порог времени ответа, учитывая специфику сервиса и ожидаемую производительность.

#### 4. Гибридные методы

Часто используется комбинация нескольких методов для определения состояния Circuit Breaker. Например, можно сочетать порог ошибок с оценкой времени ответа.

Гибридные методы позволяют более точно реагировать на разнообразные ситуации, учитывая как количество ошибок, так и изменения в производительности.

#### 5. Машинное обучение

Есть алгоритмы, которые могут динамически адаптировать параметры Circuit Breaker, анализируя паттерны трафика и поведение сервисов.

Эти системы способны самостоятельно настраивать пороги и параметры, обучаясь на исторических данных и текущем состоянии системы.

С использованием библиотеки `scikit-learn` реализуем простую модель обучения, которая предсказывает вероятность сбоя сервиса

#### 6. Логика перехода между состояниями

Помимо определения критериев активации, важно также четко определить условия для перехода из открытого в полуоткрытое и обратно в закрытое состояние

## Взаимодействие с другими паттернами (например, Bulkhead, Timeout)

#### Взаимодействие с паттерном Bulkhead

Bulkhead — это паттерн, который изолирует элементы в системе таким образом, что если один из них выходит из строя, это не влечет за собой каскадный сбой всей системы. Это достигается путем разделения элементов системы на изолированные группы.

Комбинация Bulkhead и Circuit Breaker позволяет не только предотвратить распространение сбоев, но и обеспечить более точное управление и мониторинг каждой изолированной части системы. Например, если Circuit Breaker срабатывает в одном из Bulkheads, это не влияет на другие части системы, что повышает общую устойчивость и позволяет локализовать проблемы быстрее.

Взаимодействие с паттерном Timeout

Timeout — это механизм, который предотвращает ожидание ответа от вызова в течение неопределенно долгого времени. Он ограничивает время ожидания ответа и, в случае его превышения, прерывает операцию, предотвращая зависание и потенциальные задержки в системе.

Circuit Breaker и Timeout дополняют друг друга. В то время как Timeout защищает от долгих задержек в ответах, Circuit Breaker защищает от повторных попыток доступа к уже недоступным сервисам. Использование Timeout вместе с Circuit Breaker позволяет избежать долгих периодов ожидания в случае недоступности сервисов, а также предотвращает ненужные нагрузки на сервис, который уже испытывает трудности.

#### Дополнительные взаимодействия

1. **Retry Pattern:** Этот паттерн предусматривает повторные попытки выполнения операции в случае ее сбоя. Когда используется в сочетании с Circuit Breaker, важно правильно сбалансировать логику повторных попыток, чтобы избежать излишней нагрузки на сервис.
    
2. **Rate Limiter:** Паттерн ограничения скорости запросов помогает контролировать количество операций, отправляемых к сервису за определенный период времени. Это может предотвратить перегрузку сервисов и использоваться вместе с Circuit Breaker для обеспечения дополнительной стабильности.
    
3. **Fallback:** Предусматривает альтернативные действия в случае сбоя основного сервиса. Это может быть простое возвращение статических данных, использование кеша или перенаправление запроса на другой сервис.
    

## Конфигурация и настройка для разных сценариев

#### Определение порогов срабатывания

Одним из ключевых параметров является порог ошибок, который может быть определен как абсолютное количество или как процент от общего числа запросов. Этот порог должен быть сконфигурирован таким образом, чтобы отражать нормальную операционную нагрузку и ожидаемый уровень ошибок сервиса.

Для сервисов, где время отклика важно, порог срабатывания может быть установлен на основе максимально допустимого времени ответа.

#### Длительность ожидания в в открытом состоянии

Период, в течение которого Circuit Breaker остается в открытом состоянии, должен быть достаточным для того, чтобы проблемный сервис мог восстановиться. Слишком короткое время может привести к частым срабатываниям, а слишком долгое — к ненужному простою.

#### Настройка полуоткрытого состояния

В полуоткрытом состоянии Circuit Breaker должен позволять ограниченное количество запросов для проверки работоспособности сервиса. Количество этих запросов и условия их успешности должны быть тщательно настроены.

#### Адаптация к различным условиям эксплуатации

В условиях, когда нагрузка на систему меняется, полезно иметь возможность динамически изменять параметры Circuit Breaker. Это может быть реализовано через внешние конфигурационные файлы или через административный интерфейс.



# Ресурсы

- [Паттерн Circuit Breaker](https://habr.com/ru/companies/otus/articles/778574/)
- 