Command and Query Responsibility Segregation

- Разделяем запросы в базу на команды - изменяющие операции, и запросы - чтение данных.
- База на чтения догоняет базу на запись асинхронно
- Каждая из баз оптимизируется под быструю запись/чтение (например удаляются индексы)

Этот паттерн предлагает отделить изменение данных (Command) от чтения данных (Query). Шаблон CQRS имеет две формы: простую и расширенную.

В простой форме для чтения и записи используются отдельные модели ORM (Object-Relational Mapping), но общее хранилище данных.

![[../../../../../_res/Pasted image 20241215095326.png]]

В расширенной форме используются разные хранилища данных, оптимизированные для записи и чтения данных. Данные копируются из хранилища для записи в хранилище для чтения асинхронно. В результате хранилище для чтения отстает от хранилища для записи, но в конечном итоге является согласованным. Расширенный CQRS часто используется совместно с паттерном [[Event Sourcing]].

![[../../../../../_res/Pasted image 20241215095522.png]]

Паттерн CQRS обеспечивает высокую доступность данных, независимое масштабирование систем чтения/записи и более быстрое чтение данных в микросервисах, управляемых событиями. Однако его использование увеличивает сложность системы и приводит к слабой согласованности данных. Паттерн подходит для сложных систем, где для чтения данных требуется запрос в несколько хранилищ или операции чтения и записи имеют разную нагрузку.

> Разделение моделей на чтение и запись. Позволяет подбирать подходящую технологию для каждой из моделей, использование разных баз данных, механизмов кэширования. **Однако** увеличивает сложность архитектуры добавляя командные обработчики, запросные модели, механизмы синхронизации и т.д. При асинхронных запросах теряем согласованность, необходима синхронизация данных между моделями.

> Command-query separation (CQS)

- Queries: Методы возвращают результат, не изменяя состояние объекта. Другими словами, у Query не никаких побочных эффектов.
- Commands: Методы изменяют состояние объекта, не возвращая значение.

![[../../../../../_res/Pasted image 20240930104216.png]]

- Плюсы:
	- Позволяет улучшить производительность системы
	- Улучшает масштабируемость БД (можно создавать несколько баз на запись/чтение)
	- Хорошо сочетается с Event Sourcing
- Минусы:
	- сильно усложняет архитектуру
	- данные согласованы в конечном счете