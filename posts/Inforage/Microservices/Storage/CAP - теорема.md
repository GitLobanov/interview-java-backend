> CAP **Теорема** (также известная как Теорема Бэрри) формулирует три основных свойства распределенных систем, из которых одновременно **можно гарантировать только два**. 

> Можно добиться согласованности и доступности, но только при условии, что система не может терпеть разделение сети. Аналогично, можно обеспечить доступность и терпимость к разделению, но тогда система может не гарантировать согласованность данных.

![[Pasted image 20240929135330.png]]

- C - Consistency, согласованность данных, все узлы системы видят одни и те же данные в одно и то же время
- A - Availability, каждый запрос получает ответ, даже если часть системы недоступна
- P - Partition, система продолжает функционировать, даже если происходит разделение сети.
- Гласит что можно соблюдать только два правила
- Обычно это CP, AP или просто P
- Суть в том что, если у нас согласованность данных, это может включать долгую обработку запроса, тогда как доступность здесь заключатся в минимальной задержки ответа на запрос, которая также может подразумивать неточные ответы.
- Если запрос асинхронный, мы теряем также согласованность, и при долгой задержки еще и доступность, тогда у нас выполняется только P

### AP / CP выбор

Коммуникация узлов между собой обычно происходит через асинхронную сеть, которая может задерживать или удалять сообщения. Интернет и все наши центры обработки данных обладают этим свойством, и это не маловероятные инциденты, поэтому CA системы в рамках разработки рассматриваются крайне редко.  

Availability — это именно обработка запроса с минимальной задержкой, нежели просто доступность данных. В распределенной системе невозможно одновременно Consistency и Availability по причине того, что для «C» необходим координированный доступ к данным (через блокировки или MVCC), которые в распределенной среде занимают большое время (необходим ответ от всех затронутых нодов). То есть для чтения либо жертвуем «А» и ждем, когда коммитнется транзакция, либо жертвуем «C» и читаем неполные данные (при асинхронной репликации).
### Многие системы — просто P

Представьте систему, в которой два узла (Master, Slave) и клиент. Если вдруг вы потеряли связь с Master, клиент может читать из Slave, но не может писать — нет CAP-availability.  

CP система, но если Master и Slave синхронизируются асинхронно, то клиент, может запросить данные от Slave раньше успешной синхронизации — теряем CAP-consistency.


В мире распределённых баз данных ключевую роль играет теорема **CAP (Consistency, Availability, Partition Tolerance)**, предложенная **Эриком Брюэром (Eric Brewer)** в 2000 году.

Теорема CAP в информатике гласит, что распределенное хранилище данных не может предоставить более двух из трех следующих гарантий:

- **C – Consistency (Согласованность):** каждое чтение получает самую последнюю запись или ошибку. Все узлы видят одни и те же данные в одно и то же время.
- **A – Availability (Доступность):** каждый запрос получает ответ (без ошибок), без гарантии, что он содержит самую последнюю запись. Система отвечает на запросы даже при сбоях, но может выдавать устаревшие данные.
- **P – Partition Tolerance (Устойчивость к разделению сети):** система продолжает работать, несмотря на произвольное количество сообщений, удаленных (или задержанных) сетью между узлами. Система продолжает работать, даже если сеть между узлами разорвана.

**Главный вывод теоремы CAP:** в случае сетевых проблем (P) база данных должна выбрать между строгой согласованностью (C) или доступностью (A).

![](Pasted%20image%2020250213162810.png)

**CAP теорема указывает, что распределенная система может иметь максимум два свойства из трех одновременно:**

1. **Согласованность (атомарность)** — Каждая операция чтения, должна возвращать значение, установленное в последней операции записи: то есть у каждого узла есть актуальные данные о определенном объекте (или данные во всех узлах не противоречат друг другу).
2. **Доступность** — Каждый запрос, полученный исправным узлом, влечет за собой ответ. Изначально было что: «почти все запросы должны получать ответы». Отсутствие ответа — неответ по таймауту, и все ошибки формата «сервер занят».
3. **Устойчивость к распределению:** Кластер сохраняет работоспособность при условии потери произвольного количества сообщений, посылаемых между узлами сети. Распределение означает, что все пакеты от узлов одной партиции не доходят до узлов другой партиции.

_В 2002 году Сет Джилберт и Нэнси Линч из Массачусетского технологического института подобрали формальные модели асинхронных и синхронных распределённых вычислений, в рамках которых показано выполнение теоремы CAP в условиях отсутствия синхронизации (общих часов) у узлов распределённой системы и принципиальную возможность компромисса в частично синхронных системах. В этой работе «согласованность» в смысле теоремы CAP соотнесена с выполнением первых двух требований ACID — атомарности и согласованности. В дальнейшем, многие практики ссылались на данную работу как на доказательство теоремы CAP._


- **CP (Consistency + Partition Tolerance)**
    - Строгая согласованность важнее доступности (во время сетевых проблем система может отказать в обслуживании)
    - Если важны точные, актуальные данные (банковские транзакции, финансовые операции).
    - Примеры СУБД: MongoDB (с Strong Consistency), HBase, Zookeeper
- **AP (Availability + Partition Tolerance)**
    - Доступность важнее строгой согласованности (временно возможны устаревшие данные)
    - Если важнее всегда получать ответ, даже если данные могут быть устаревшими (соцсети, системы логирования)
    - Cassandra, DynamoDB, Riak
- **CA (Consistency + Availability)**
    - Теоретически невозможна в распределённых системах, потому что сеть всегда может дать сбой
    - В реальном мире сеть не идеальна, поэтому отказоустойчивость (P) нельзя игнорировать.  
        Если сеть рвётся, приходится жертвовать либо C, либо A.
    - Реляционные базы в локальной сети (PostgreSQL, MySQL, MSSQL в монолитной архитектуре)

### Теорема CAP в отношении ACID и BASE

- **ACID (Atomicity, Consistency, Isolation, Durability)** – это не противоречие CAP, а подход для локальных транзакций.
- **BASE (Basically Available, Soft State, Eventually Consistent)** – модель NoSQL, строится вокруг AP-решений из CAP.

> В реальности все системы балансируют между CAP, BASE и ACID, используя кванты согласованности и кэширование.