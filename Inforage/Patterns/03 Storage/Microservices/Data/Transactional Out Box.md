> Заводится отдельная таблица, и уже евенты пишутся не в шину Kafka, а в базу данных. Временное хранилище евентов. 

> Message Relay - сервис, который на фоне разгребает евенты и отправляет результаты в Кафку, Message Brocker.

- Сообщения пишутся в таблицу
- Соблюдается атомарность
- Отдельный процесс = отправка сообщений
- Если легла кафка, Message Relay бесконечно выполняет попытку обработать евент, и в один момент кафка уже может восстановиться
- Если легла база данных, Message Relay, может снова обработать процесс, но в кафку запишется дубликат. Поэтому потребители должны реализовать ключ идемпотентности, чтобы посмотреть обработалось такое событие или нет

![[Pasted image 20240928162421.png]]

- Паттерн Outbox используется для обеспечения надежной доставки событий и сообщений в распределенных системах. Он основан на идее записи сообщений в специальную таблицу (outbox) в одной транзакции вместе с изменениями в основной бизнес-логике.
- Когда бизнес-операция завершается успешно, соответствующее сообщение помещается в таблицу outbox. Затем отдельный процесс или служба, например, фонова задача, периодически проверяет эту таблицу, извлекает сообщения и отправляет их в систему обмена сообщениями (например, Kafka или RabbitMQ).
- Преимущества: повышает надежность, так как события не потеряются, даже если система аварийно завершит работу после изменения состояния.

- Используется для работы с распределенными транзакциями как аналог [[Event Sourcing]]
- Когда сервис изменяет сущность, он делает запись об изменении в отдельную таблицу. Отдельный процесс мониторит изменения этой таблицы и отправляет сообщения об изменениях в брокер сообщений.